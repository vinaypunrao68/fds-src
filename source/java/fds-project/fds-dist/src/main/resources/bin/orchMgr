#!/bin/bash

##
# this script is used for testing only, should not be used in production
# environment

ORIGINAL_ARGS=("${@}")

export fds_root=/fds

declare -a NEW_ARGS
for i in "${ORIGINAL_ARGS[@]}"
do
  case $i in
    --fds-root=*)
      fds_root="${i#*=}"
      # This is passed on manually below, don't pass the original.
      ;;

    --debug-port=*)
      DEBUG_PORT="${i#*=}"
      # This is used to create DEBUG_OPTS, don't pass to OM.
      ;;

    *)
      # Pass this arg on to OM.
      NEW_ARGS+=("${i}")
      ;;
  esac
done

# LD_LIBRARY_PATH dependencies
export LD_LIBRARY_PATH=../lib
export LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:/opt/fds-deps/embedded/lib
export LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:/opt/fds-deps/embedded/jre/lib/amd64

export PATH=/usr/local/sbin
export PATH=${PATH}:/usr/local/bin
export PATH=${PATH}:/usr/sbin
export PATH=${PATH}:/usr/bin
export PATH=${PATH}:/sbin
export PATH=${PATH}:/bin
export PATH=${PATH}:/opt/fds-deps/embedded/bin
export PATH=${PATH}:/opt/fds-deps/embedded/jre/bin
export PATH=${PATH}:./bin
export PATH=${PATH}:../sbin

if [[ ! -z "${DEBUG_PORT}" ]]; then
    DEBUG_OPTS='-Xdebug -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address='"${DEBUG_PORT}"
fi

# JAVA dependencies
export OM_JAVA_OPTS="-Xmx2048M -Xms20M"
export JAVA_HOME=/opt/fds-deps/embedded/jre

# JAVA CLASSPATH dependencies
export CLASSPATH=${CLASSPATH}:../lib/java/\*

# JAVA Main executable dependency
export OM_MAIN_CLASS=com.formationds.om.Main

"${JAVA_HOME}"/bin/java ${OM_JAVA_OPTS} \
                        -cp "${CLASSPATH}" \
                        ${DEBUG_OPTS} \
                        "${OM_MAIN_CLASS}" \
                        --foreground \
                        --fds-root="${fds_root}" \
                        "${NEW_ARGS[@]}" > ./om.out 2>&1
